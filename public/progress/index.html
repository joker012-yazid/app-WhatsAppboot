<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Job Progress - WhatsApp Bot POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
        color: #e2e8f0;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      /* Header Card */
      .header-card {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(20, 184, 166, 0.1) 100%);
        border: 1px solid rgba(6, 182, 212, 0.3);
        border-radius: 20px;
        padding: 28px;
        margin-bottom: 20px;
        animation: slideIn 0.5s ease-out;
        backdrop-filter: blur(10px);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(6, 182, 212, 0.2);
        color: #22d3ee;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
      }

      .header-badge svg {
        width: 14px;
        height: 14px;
      }

      .header-card h1 {
        font-size: 26px;
        font-weight: 700;
        color: #f1f5f9;
        margin-bottom: 8px;
      }

      .device-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #94a3b8;
        font-size: 14px;
      }

      .device-info svg {
        width: 16px;
        height: 16px;
        color: #64748b;
      }

      /* Status Card */
      .status-card {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        animation: slideIn 0.5s ease-out 0.1s both;
      }

      .status-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .status-header h2 {
        font-size: 16px;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .current-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 30px;
        font-size: 13px;
        font-weight: 600;
      }

      .status-PENDING { background: rgba(234, 179, 8, 0.15); color: #fbbf24; border: 1px solid rgba(234, 179, 8, 0.3); }
      .status-QUOTED { background: rgba(168, 85, 247, 0.15); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.3); }
      .status-APPROVED { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
      .status-REJECTED { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
      .status-IN_PROGRESS { background: rgba(6, 182, 212, 0.15); color: #22d3ee; border: 1px solid rgba(6, 182, 212, 0.3); }
      .status-COMPLETED { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.4); }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Progress Steps */
      .progress-steps {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin-top: 8px;
      }

      .progress-steps::before {
        content: '';
        position: absolute;
        top: 14px;
        left: 20px;
        right: 20px;
        height: 3px;
        background: rgba(148, 163, 184, 0.2);
        border-radius: 2px;
      }

      .progress-line {
        position: absolute;
        top: 14px;
        left: 20px;
        height: 3px;
        background: linear-gradient(90deg, #06b6d4 0%, #14b8a6 100%);
        border-radius: 2px;
        transition: width 0.5s ease;
      }

      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        position: relative;
        z-index: 1;
      }

      .step-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #1e293b;
        border: 3px solid rgba(148, 163, 184, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .step-circle svg {
        width: 14px;
        height: 14px;
        color: #64748b;
      }

      .step.completed .step-circle {
        background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
        border-color: transparent;
      }

      .step.completed .step-circle svg {
        color: white;
      }

      .step.active .step-circle {
        border-color: #06b6d4;
        box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
      }

      .step-label {
        font-size: 11px;
        color: #64748b;
        text-align: center;
        font-weight: 500;
      }

      .step.completed .step-label,
      .step.active .step-label {
        color: #e2e8f0;
      }

      /* Timeline Card */
      .timeline-card {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        animation: slideIn 0.5s ease-out 0.2s both;
      }

      .timeline-card h2 {
        font-size: 16px;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 20px;
      }

      .timeline {
        position: relative;
        padding-left: 28px;
      }

      .timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: rgba(148, 163, 184, 0.2);
      }

      .timeline-item {
        position: relative;
        padding-bottom: 24px;
      }

      .timeline-item:last-child {
        padding-bottom: 0;
      }

      .timeline-dot {
        position: absolute;
        left: -22px;
        top: 2px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #06b6d4;
        border: 2px solid #0f172a;
      }

      .timeline-item:not(:first-child) .timeline-dot {
        background: #475569;
      }

      .timeline-content {
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 12px;
        padding: 14px 16px;
      }

      .timeline-status {
        font-weight: 600;
        color: #f1f5f9;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .timeline-notes {
        font-size: 13px;
        color: #94a3b8;
        margin-bottom: 6px;
      }

      .timeline-time {
        font-size: 12px;
        color: #64748b;
      }

      /* Photos Card */
      .photos-card {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        animation: slideIn 0.5s ease-out 0.3s both;
      }

      .photos-card h2 {
        font-size: 16px;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 20px;
      }

      .photos-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .photo-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 1;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .photo-item:hover {
        transform: scale(1.02);
      }

      .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .photo-label {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 8px 12px;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        font-size: 12px;
        color: white;
      }

      .no-photos {
        text-align: center;
        padding: 32px;
        color: #64748b;
      }

      .no-photos svg {
        width: 48px;
        height: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
      }

      /* Info Card */
      .info-card {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        animation: slideIn 0.5s ease-out 0.4s both;
      }

      .info-card h2 {
        font-size: 16px;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 16px;
      }

      .info-grid {
        display: grid;
        gap: 12px;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        color: #64748b;
        font-size: 13px;
      }

      .info-value {
        color: #f1f5f9;
        font-weight: 500;
        font-size: 14px;
      }

      /* Footer */
      .footer {
        text-align: center;
        padding: 24px;
        color: #64748b;
        font-size: 12px;
      }

      .footer-brand {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .footer-brand svg {
        width: 20px;
        height: 20px;
        color: #06b6d4;
      }

      /* Loading State */
      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        gap: 16px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(6, 182, 212, 0.2);
        border-top-color: #06b6d4;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Error State */
      .error-card {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 16px;
        padding: 32px;
        text-align: center;
        animation: slideIn 0.5s ease-out;
      }

      .error-card svg {
        width: 48px;
        height: 48px;
        color: #f87171;
        margin-bottom: 16px;
      }

      .error-card h2 {
        color: #f87171;
        margin-bottom: 8px;
      }

      .error-card p {
        color: #94a3b8;
      }

      /* Lightbox */
      .lightbox {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .lightbox.show {
        display: flex;
      }

      .lightbox img {
        max-width: 100%;
        max-height: 90vh;
        border-radius: 8px;
      }

      .lightbox-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      @media (max-width: 640px) {
        body {
          padding: 12px;
        }

        .header-card h1 {
          font-size: 22px;
        }

        .photos-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .progress-steps {
          gap: 4px;
        }

        .step-label {
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Loading State -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="color: #94a3b8;">Loading job progress...</p>
      </div>

      <!-- Error State -->
      <div id="error" class="error-card" style="display: none;">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h2>Error</h2>
        <p id="errorMessage">Unable to load job progress.</p>
      </div>

      <!-- Content -->
      <div id="content" style="display: none;">
        <!-- Header -->
        <div class="header-card">
          <div class="header-badge">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            Job Progress
          </div>
          <h1 id="jobTitle">Loading...</h1>
          <div class="device-info">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            <span id="deviceInfo">‚Äî</span>
          </div>
        </div>

        <!-- Info Card -->
        <div class="info-card">
          <h2>‚ÑπÔ∏è Job Information</h2>
          <div class="info-grid">
            <div class="info-row">
              <span class="info-label">Customer</span>
              <span class="info-value" id="customerName">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="info-label">Device</span>
              <span class="info-value" id="deviceDetails">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="info-label">Priority</span>
              <span class="info-value" id="priority">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="info-label">Created</span>
              <span class="info-value" id="createdAt">‚Äî</span>
            </div>
            <div class="info-row" id="dueDateRow" style="display: none;">
              <span class="info-label">Expected Due</span>
              <span class="info-value" id="dueDate">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Status Card -->
        <div class="status-card">
          <div class="status-header">
            <h2>Current Status</h2>
            <div id="currentStatus" class="current-status status-PENDING">
              <span class="status-dot"></span>
              <span>Pending</span>
            </div>
          </div>
          
          <div class="progress-steps">
            <div class="progress-line" id="progressLine"></div>
            <div class="step" data-step="PENDING">
              <div class="step-circle">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <span class="step-label">Received</span>
            </div>
            <div class="step" data-step="IN_PROGRESS">
              <div class="step-circle">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
              <span class="step-label">In Progress</span>
            </div>
            <div class="step" data-step="COMPLETED">
              <div class="step-circle">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <span class="step-label">Completed</span>
            </div>
          </div>
        </div>

        <!-- Timeline Card (with Photos integrated) -->
        <div class="timeline-card">
          <h2>üìã Progress & Timeline</h2>
          <p style="color: #94a3b8; font-size: 13px; margin-bottom: 8px;">Ikuti perkembangan kerja pembaikan barang anda secara terperinci</p>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
            <span style="display: inline-flex; align-items: center; gap: 4px; background: rgba(245,158,11,0.15); color: #fbbf24; padding: 4px 10px; border-radius: 20px; font-size: 11px;">üì• Diterima</span>
            <span style="display: inline-flex; align-items: center; gap: 4px; background: rgba(139,92,246,0.15); color: #a78bfa; padding: 4px 10px; border-radius: 20px; font-size: 11px;">üîç Diagnosis</span>
            <span style="display: inline-flex; align-items: center; gap: 4px; background: rgba(6,182,212,0.15); color: #22d3ee; padding: 4px 10px; border-radius: 20px; font-size: 11px;">üîß Dibaiki</span>
            <span style="display: inline-flex; align-items: center; gap: 4px; background: rgba(16,185,129,0.15); color: #34d399; padding: 4px 10px; border-radius: 20px; font-size: 11px;">üéâ Siap</span>
          </div>
          <div id="timeline" class="timeline">
            <!-- Timeline items will be inserted here -->
          </div>
          <div id="noTimeline" style="display: none; text-align: center; padding: 40px 20px; color: #64748b;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
            <p style="font-size: 16px; font-weight: 500; color: #94a3b8; margin-bottom: 8px;">Belum ada update</p>
            <p style="font-size: 13px;">Kami akan update progress kerja di sini. Sila refresh page dari masa ke semasa.</p>
          </div>
        </div>

        <!-- Footer -->
        <div class="footer">
          <div class="footer-brand">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            WhatsApp Bot POS
          </div>
          <p>This page auto-refreshes every 30 seconds</p>
        </div>
      </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
      <button class="lightbox-close" onclick="closeLightbox()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <img id="lightboxImage" src="" alt="Photo">
    </div>

    <script>
      // Extract token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const contentEl = document.getElementById('content');
      const errorMessageEl = document.getElementById('errorMessage');

      // Status order for progress calculation (simplified: Received ‚Üí In Progress ‚Üí Completed)
      const statusOrder = ['PENDING', 'IN_PROGRESS', 'COMPLETED'];
      const statusLabels = {
        PENDING: 'Received',
        QUOTED: 'In Progress',
        APPROVED: 'In Progress',
        REJECTED: 'Cancelled',
        IN_PROGRESS: 'In Progress',
        COMPLETED: 'Completed'
      };

      function showError(message) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        contentEl.style.display = 'none';
        errorMessageEl.textContent = message;
      }

      function showContent() {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'none';
        contentEl.style.display = 'block';
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-MY', {
          day: 'numeric',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      function updateProgressSteps(currentStatus) {
        const steps = document.querySelectorAll('.step');
        const progressLine = document.getElementById('progressLine');
        
        // Map status to step index (3 steps: Received, In Progress, Completed)
        const stepMapping = {
          'PENDING': 0,
          'QUOTED': 1,
          'APPROVED': 1,
          'REJECTED': 1,
          'IN_PROGRESS': 1,
          'COMPLETED': 2
        };
        
        const currentIndex = stepMapping[currentStatus] || 0;
        
        steps.forEach((step, index) => {
          step.classList.remove('completed', 'active');
          if (index < currentIndex) {
            step.classList.add('completed');
          } else if (index === currentIndex) {
            step.classList.add('active');
            if (currentStatus === 'COMPLETED') {
              step.classList.add('completed');
            }
          }
        });
        
        // Calculate progress line width
        const totalSteps = steps.length - 1;
        const progressPercent = (currentIndex / totalSteps) * 100;
        progressLine.style.width = `calc(${progressPercent}% - 40px)`;
      }

      // Phase labels for work progress
      const phaseLabels = {
        troubleshoot: { label: 'Troubleshoot', icon: 'üîç', desc: 'Sedang mendiagnosis masalah' },
        repair: { label: 'Repair', icon: 'üõ†Ô∏è', desc: 'Sedang membaiki' },
        order: { label: 'Order Parts', icon: 'üì¶', desc: 'Menunggu alat ganti' },
        install: { label: 'Pemasangan', icon: '‚öôÔ∏è', desc: 'Memasang komponen' },
        testing: { label: 'Testing/QA', icon: '‚úîÔ∏è', desc: 'Ujian kualiti' }
      };

      function parseNotes(notes) {
        if (!notes) return { phase: null, reject: null, text: '' };
        
        const phaseMatch = notes.match(/\[PHASE:(\w+)\]/);
        const rejectMatch = notes.match(/\[REJECT:(.*?)\]/);
        const cleanText = notes
          .replace(/\[PHASE:\w+\]\s*/g, '')
          .replace(/\[REJECT:.*?\]\s*/g, '')
          .trim();
        
        return {
          phase: phaseMatch ? phaseMatch[1] : null,
          reject: rejectMatch ? rejectMatch[1] : null,
          text: cleanText
        };
      }

      function renderTimeline(history, photos, jobDiagnosis) {
        const timeline = document.getElementById('timeline');
        const noTimeline = document.getElementById('noTimeline');
        
        // Combine history and photos into a single timeline
        const timelineItems = [];
        
        // Group photos with status updates (photos uploaded within 5 minutes of status update)
        const TIME_WINDOW_MS = 5 * 60 * 1000; // 5 minutes
        
        // Add status history items - each item now contains its own catatan/fasa
        if (history && history.length > 0) {
          history.forEach((item, idx) => {
            // Parse the notes field which now contains catatan + fasa
            const parsed = parseNotes(item.notes);
            const statusDate = new Date(item.createdAt);
            
            // Find photos uploaded around the same time as this status update
            const relatedPhotos = photos && photos.length > 0 
              ? photos.filter(photo => {
                  const photoDate = new Date(photo.createdAt);
                  const timeDiff = Math.abs(photoDate - statusDate);
                  // Photos uploaded within 5 minutes before or after status update
                  return timeDiff <= TIME_WINDOW_MS;
                })
              : [];
            
            timelineItems.push({
              type: 'status',
              date: statusDate,
              data: item,
              parsedNotes: parsed, // Store parsed notes for each item
              photos: relatedPhotos // Attach related photos to this status update
            });
          });
        }
        
        // Add standalone photo items (photos not associated with any status update)
        if (photos && photos.length > 0) {
          const allGroupedPhotoIds = new Set();
          timelineItems.forEach(item => {
            if (item.photos && item.photos.length > 0) {
              item.photos.forEach(photo => allGroupedPhotoIds.add(photo.id));
            }
          });
          
          photos.forEach(photo => {
            if (!allGroupedPhotoIds.has(photo.id)) {
              timelineItems.push({
                type: 'photo',
                date: new Date(photo.createdAt),
                data: photo
              });
            }
          });
        }
        
        // Sort by date (newest first)
        timelineItems.sort((a, b) => b.date - a.date);
        
        if (timelineItems.length === 0) {
          timeline.innerHTML = '';
          noTimeline.style.display = 'block';
          return;
        }
        
        // Status icons and descriptions for more detail
        const statusDetails = {
          PENDING: { 
            icon: 'üì•', 
            title: 'Barang Diterima', 
            desc: 'Barang anda telah diterima dan sedang menunggu untuk didiagnosis.',
            color: '#f59e0b'
          },
          QUOTED: { 
            icon: 'üîç', 
            title: 'Sedang Diagnosis', 
            desc: 'Technician sedang memeriksa dan mendiagnosis masalah barang anda.',
            color: '#8b5cf6'
          },
          APPROVED: { 
            icon: '‚úÖ', 
            title: 'Quote Diluluskan', 
            desc: 'Anda telah meluluskan quote. Kerja pembaikan akan dimulakan.',
            color: '#10b981'
          },
          REJECTED: { 
            icon: '‚ùå', 
            title: 'Tidak Dapat Dibaiki', 
            desc: 'Maaf, barang tidak dapat dibaiki.',
            color: '#ef4444'
          },
          IN_PROGRESS: { 
            icon: 'üîß', 
            title: 'Sedang Dibaiki', 
            desc: 'Technician sedang membaiki barang anda.',
            color: '#06b6d4'
          },
          COMPLETED: { 
            icon: 'üéâ', 
            title: 'Siap Untuk Diambil', 
            desc: 'Barang anda telah siap! Sila datang untuk mengambil.',
            color: '#10b981'
          }
        };

        noTimeline.style.display = 'none';
        timeline.innerHTML = timelineItems.map((item, index) => {
          if (item.type === 'photo') {
            // Render photo item with more detail
            const photo = item.data;
            return `
              <div class="timeline-item" style="border-left: 3px solid #10b981; margin-left: 8px; padding-left: 20px;">
                <div class="timeline-dot" style="background: #10b981; left: -11px;"></div>
                <div class="timeline-content" style="background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%); border: 1px solid rgba(16,185,129,0.2); border-radius: 12px; padding: 16px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 20px;">üì∑</span>
                    <div>
                      <div style="font-weight: 600; color: #10b981;">Gambar Progress Ditambah</div>
                      <div style="font-size: 12px; color: #64748b;">Technician telah menambah gambar kerja</div>
                    </div>
                  </div>
                  ${photo.label ? `<div style="background: rgba(16,185,129,0.15); color: #34d399; padding: 6px 12px; border-radius: 8px; font-size: 13px; margin-bottom: 10px;">üìù ${photo.label}</div>` : ''}
                  <div style="margin-top: 8px;">
                    <img 
                      src="${photo.url}" 
                      alt="${photo.label || 'Progress photo'}" 
                      loading="lazy"
                      onclick="openLightbox('${photo.url}')"
                      style="max-width: 100%; max-height: 200px; border-radius: 8px; cursor: pointer; border: 2px solid rgba(16,185,129,0.3); transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                      onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 24px rgba(16,185,129,0.3)';"
                      onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                    >
                    <div style="font-size: 11px; color: #64748b; margin-top: 6px;">Klik gambar untuk view penuh</div>
                  </div>
                  <div class="timeline-time" style="margin-top: 12px; font-size: 12px;">${formatDate(photo.createdAt)}</div>
                </div>
              </div>
            `;
          } else {
            // Render status item with more detail
            const statusItem = item.data;
            // Use parsedNotes from each history item (now stored with full catatan + fasa)
            const parsed = item.parsedNotes || parseNotes(statusItem.notes);
            const phaseInfo = parsed.phase ? phaseLabels[parsed.phase] : null;
            const statusInfo = statusDetails[statusItem.status] || { icon: 'üìã', title: statusItem.status, desc: '', color: '#64748b' };
            const hasActualCatatan = parsed.text && !parsed.text.includes('Status updated');
            
            // Build phase section
            let phaseSection = '';
            if (phaseInfo && (statusItem.status === 'IN_PROGRESS' || statusItem.status === 'QUOTED' || statusItem.status === 'APPROVED')) {
              phaseSection = `
                <div style="background: linear-gradient(135deg, rgba(6,182,212,0.15) 0%, rgba(6,182,212,0.05) 100%); border: 1px solid rgba(6,182,212,0.3); border-radius: 10px; padding: 12px; margin-top: 10px;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 24px;">${phaseInfo.icon}</span>
                    <div>
                      <div style="font-weight: 600; color: #22d3ee; font-size: 14px;">Fasa: ${phaseInfo.label}</div>
                      <div style="font-size: 12px; color: #94a3b8;">${phaseInfo.desc}</div>
                    </div>
                  </div>
                </div>
              `;
            }
            
            // Build reject section
            let rejectSection = '';
            if (parsed.reject && statusItem.status === 'REJECTED') {
              rejectSection = `
                <div style="background: linear-gradient(135deg, rgba(239,68,68,0.15) 0%, rgba(239,68,68,0.05) 100%); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; padding: 12px; margin-top: 10px;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    <div>
                      <div style="font-weight: 600; color: #f87171; font-size: 14px;">Sebab: ${parsed.reject}</div>
                      <div style="font-size: 12px; color: #fca5a5;">Sila hubungi kami untuk maklumat lanjut</div>
                    </div>
                  </div>
                </div>
              `;
            }
            
            // Build technician notes section
            let noteSection = '';
            if (hasActualCatatan) {
              // Show actual technician catatan (from job.diagnosis) - more prominent
              noteSection = `
                <div style="background: linear-gradient(135deg, rgba(6,182,212,0.15) 0%, rgba(6,182,212,0.05) 100%); border: 1px solid rgba(6,182,212,0.3); border-left: 4px solid #06b6d4; padding: 14px 16px; border-radius: 0 10px 10px 0; margin-top: 12px;">
                  <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <span style="font-size: 20px;">üí¨</span>
                    <div style="flex: 1;">
                      <div style="font-size: 11px; color: #22d3ee; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">üìù Catatan Technician</div>
                      <div style="font-size: 15px; color: #f1f5f9; line-height: 1.6; font-weight: 500;">${parsed.text}</div>
                    </div>
                  </div>
                </div>
              `;
            } else if (parsed.text && !parsed.text.includes('Status updated')) {
              // Show other notes that aren't auto-generated
              noteSection = `
                <div style="background: rgba(100,116,139,0.1); border-left: 3px solid #64748b; padding: 12px 16px; border-radius: 0 8px 8px 0; margin-top: 10px;">
                  <div style="display: flex; align-items: flex-start; gap: 8px;">
                    <span style="font-size: 16px;">üí¨</span>
                    <div>
                      <div style="font-size: 11px; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Catatan</div>
                      <div style="font-size: 14px; color: #e2e8f0; line-height: 1.5;">${parsed.text}</div>
                    </div>
                  </div>
                </div>
              `;
            }
            
            // Build photos section - show photos related to this status update
            let photosSection = '';
            if (item.photos && item.photos.length > 0) {
              const photosHtml = item.photos.map(photo => `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid ${statusInfo.color}20;">
                  ${photo.label ? `<div style="background: rgba(16,185,129,0.15); color: #34d399; padding: 6px 12px; border-radius: 8px; font-size: 13px; margin-bottom: 10px; display: inline-block;">üìù ${photo.label}</div>` : ''}
                  <div style="margin-top: ${photo.label ? '0' : '10px'};">
                    <img 
                      src="${photo.url}" 
                      alt="${photo.label || 'Progress photo'}" 
                      loading="lazy"
                      onclick="openLightbox('${photo.url}')"
                      style="max-width: 100%; max-height: 200px; border-radius: 8px; cursor: pointer; border: 2px solid ${statusInfo.color}40; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                      onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 24px ${statusInfo.color}40';"
                      onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                    >
                    <div style="font-size: 11px; color: #64748b; margin-top: 6px;">Klik gambar untuk view penuh</div>
                  </div>
                </div>
              `).join('');
              
              photosSection = `
                <div style="background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%); border: 1px solid rgba(16,185,129,0.2); border-radius: 10px; padding: 12px; margin-top: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üì∑</span>
                    <div style="font-weight: 600; color: #10b981; font-size: 13px;">Gambar Progress (${item.photos.length} foto${item.photos.length > 1 ? 's' : ''})</div>
                  </div>
                  ${photosHtml}
                </div>
              `;
            }
            // Don't show "Status updated from X to Y" auto-messages
            
            return `
              <div class="timeline-item" style="border-left: 3px solid ${statusInfo.color}; margin-left: 8px; padding-left: 20px;">
                <div class="timeline-dot" style="background: ${statusInfo.color}; left: -11px;"></div>
                <div class="timeline-content" style="background: linear-gradient(135deg, ${statusInfo.color}15 0%, ${statusInfo.color}08 100%); border: 1px solid ${statusInfo.color}30; border-radius: 12px; padding: 16px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <span style="font-size: 28px;">${statusInfo.icon}</span>
                    <div>
                      <div style="font-weight: 700; color: ${statusInfo.color}; font-size: 16px;">${statusInfo.title}</div>
                      <div style="font-size: 13px; color: #94a3b8; line-height: 1.4;">${statusInfo.desc}</div>
                    </div>
                  </div>
                  ${phaseSection}
                  ${rejectSection}
                  ${noteSection}
                  ${photosSection}
                  <div class="timeline-time" style="margin-top: 12px; font-size: 12px; color: #64748b;">
                    üïê ${formatDate(statusItem.createdAt)}
                  </div>
                </div>
              </div>
            `;
          }
        }).join('');
      }

      function openLightbox(imageUrl) {
        document.getElementById('lightboxImage').src = imageUrl;
        document.getElementById('lightbox').classList.add('show');
      }

      function closeLightbox() {
        document.getElementById('lightbox').classList.remove('show');
      }

      // Close lightbox on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeLightbox();
      });

      async function loadJobProgress() {
        if (!token) {
          showError('Invalid or missing token. Please use the QR code link provided.');
          return;
        }

        try {
          // Get base URL from current location
          const baseUrl = window.location.origin;
          
          // Fetch job data
          const response = await fetch(`${baseUrl}/api/jobs/progress/${token}`);
          
          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Unable to load job progress');
          }

          const data = await response.json();
          const { job, history, photos } = data;

          // Update header
          document.getElementById('jobTitle').textContent = job.title;
          document.getElementById('deviceInfo').textContent = [
            job.device.deviceType,
            job.device.brand,
            job.device.model
          ].filter(Boolean).join(' ') || 'Unknown device';

          // Update status
          const statusEl = document.getElementById('currentStatus');
          statusEl.className = `current-status status-${job.status}`;
          statusEl.innerHTML = `
            <span class="status-dot"></span>
            <span>${statusLabels[job.status] || job.status}</span>
          `;

          // Update progress steps
          updateProgressSteps(job.status);

          // Update info
          document.getElementById('customerName').textContent = job.customer.name;
          document.getElementById('deviceDetails').textContent = [
            job.device.deviceType,
            job.device.brand,
            job.device.model
          ].filter(Boolean).join(' ') || '‚Äî';
          document.getElementById('priority').textContent = job.priority;
          document.getElementById('createdAt').textContent = formatDate(job.createdAt);
          
          if (job.dueDate) {
            document.getElementById('dueDateRow').style.display = 'flex';
            document.getElementById('dueDate').textContent = formatDate(job.dueDate);
          }

          // Render combined timeline with photos (includes catatan and fasa kerja)
          // Pass job.diagnosis so we can show the actual technician notes
          renderTimeline(history, photos, job.diagnosis);

          showContent();
        } catch (error) {
          console.error('Error loading job progress:', error);
          showError(error.message || 'Unable to load job progress. Please try again later.');
        }
      }

      // Initial load
      loadJobProgress();

      // Auto-refresh every 30 seconds
      setInterval(loadJobProgress, 30000);
    </script>
  </body>
</html>

