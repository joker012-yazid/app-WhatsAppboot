(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[663],{4776:function(e,t,n){Promise.resolve().then(n.bind(n,5076))},5076:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return a}});var r=n(7573),o=n(2628);function a(e){let{children:t}=e;return(0,r.jsx)(o.Z,{children:t})}},2628:function(e,t,n){"use strict";n.d(t,{Z:function(){return u}});var r=n(7573),o=n(1695),a=n(7653),s=n(1799);function u(e){let{children:t,redirectOnFail:n=!0}=e,{user:u,loading:i,error:l,status:c}=(0,s.a)(),h=(0,o.useRouter)();return((0,a.useEffect)(()=>{if(n&&!i&&(!u||l||"unauthenticated"===c)){let e=l?"?reason=".concat(encodeURIComponent(l)):"";h.replace("/login".concat(e))}},[u,i,l,h,n,c]),i)?(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading session..."}):!u&&n?null:(0,r.jsx)(r.Fragment,{children:t})}},5118:function(e,t,n){"use strict";n.d(t,{QW:function(){return v},R1:function(){return d},SC:function(){return c},pE:function(){return f},sg:function(){return h},zi:function(){return m}});var r=n(4859);let o=r.env.NEXT_PUBLIC_API_BASE_URL||r.env.NEXT_PUBLIC_API_URL||"http://localhost:4000",a=()=>window.sessionStorage,s="accessToken",u="refreshToken",i=e=>e.startsWith("/api/auth/login")||e.startsWith("/api/auth/register")||e.startsWith("/api/auth/refresh"),l=!1;async function c(e){var t,n,r,h,d,f,v,m,g;let p=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{method:T="GET",body:y,headers:w,_retry:k}=p,E="".concat(o).concat(e),P=a(),I=(null==P?void 0:P.getItem(s))||null,b=(null==P?void 0:P.getItem(u))||null;try{let a=await fetch(E,{method:T,headers:{"Content-Type":"application/json",...w||{},...I&&!i?{Authorization:"Bearer ".concat(I)}:{}},body:y?JSON.stringify(y):void 0,credentials:"include"}),l=await a.text(),d={};if(l)try{d=JSON.parse(l)}catch(e){d={message:l}}if(!a.ok){let l=(null==d?void 0:d.message)||"HTTP ".concat(a.status,": ").concat(a.statusText);if(console.error("[API] Request failed: ".concat(T," ").concat(E," - ").concat(l)),401===a.status&&(console.warn("[API] Unauthorized â€“ will let auth layer handle redirect / logout"),!i(e)&&!k&&b)){try{let t=await fetch("".concat(o,"/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:b}),credentials:"include"});if(t.ok){let n=await t.json(),r=null==n?void 0:n.accessToken,o=null==n?void 0:n.refreshToken;return r&&(null==P||P.setItem(s,r)),o&&(null==P||P.setItem(u,o)),c(e,{...p,_retry:!0})}}catch(e){console.error("[API] Refresh token request failed",e)}null==P||P.removeItem(s),null==P||P.removeItem(u)}if(502===a.status||503===a.status||504===a.status){let e={code:"BACKEND_UNAVAILABLE",message:"Backend API server is not running. Please start the API server on port 4000."};try{null===(n=globalThis.__toast)||void 0===n||null===(t=n.error)||void 0===t||t.call(n,e.message)}catch(e){}let r=Error(e.message);throw r.code=e.code,r}try{null===(h=globalThis.__toast)||void 0===h||null===(r=h.error)||void 0===r||r.call(h,l)}catch(e){}throw Error(l)}return d}catch(t){if((null==t?void 0:null===(d=t.message)||void 0===d?void 0:d.includes("Failed to fetch"))||(null==t?void 0:null===(f=t.message)||void 0===f?void 0:f.includes("NetworkError"))||(null==t?void 0:null===(v=t.message)||void 0===v?void 0:v.includes("ECONNREFUSED"))||(null==t?void 0:t.name)==="TypeError"){let e={code:"BACKEND_UNAVAILABLE",message:"Backend API server is not running. Please start the API server on port 4000."};l||(console.error("[API] Connection error: ".concat(T," ").concat(E),t),l=!0);try{null===(g=globalThis.__toast)||void 0===g||null===(m=g.error)||void 0===m||m.call(g,e.message)}catch(e){}let n=Error(e.message);throw n.code=e.code,n}if(t instanceof Error&&t.message)throw t;let e=(null==t?void 0:t.message)||"Failed to fetch: ".concat(T," ").concat(E);throw console.error("[API] Request error: ".concat(T," ").concat(E),t),Error(e)}}let h=(e,t)=>c(e,{method:"POST",body:t}),d=e=>c(e,{method:"GET"}),f=(e,t)=>c(e,{method:"PUT",body:t}),v=e=>c(e,{method:"DELETE"});async function m(e,t){let n=await fetch("".concat(o).concat(e),{method:"POST",body:t,credentials:"include"}),r=await n.text(),a=r?JSON.parse(r):{};if(!n.ok)throw Error((null==a?void 0:a.message)||"HTTP ".concat(n.status));return a}},1799:function(e,t,n){"use strict";n.d(t,{H:function(){return c},a:function(){return h}});var r=n(7573),o=n(7653),a=n(5118);let s=(0,o.createContext)(void 0),u=()=>window.sessionStorage,i="accessToken",l="refreshToken",c=e=>{let{children:t}=e,[n,c]=(0,o.useState)(null),[h,d]=(0,o.useState)("authenticating"),[f,v]=(0,o.useState)(null),[m,g]=(0,o.useState)(null),p="authenticating"===h,T=(0,o.useCallback)(()=>{let e=u();null==e||e.removeItem(i),null==e||e.removeItem(l),g(null)},[]),y=(0,o.useCallback)(()=>{let e=u();return e?{access:e.getItem(i),refresh:e.getItem(l)}:{access:null,refresh:null}},[]),w=(0,o.useCallback)((e,t)=>{let n=u();n&&(e&&n.setItem(i,e),t&&n.setItem(l,t))},[]),k=(0,o.useCallback)(async()=>{let e=await (0,a.R1)("/api/auth/me");return c(e),d("authenticated"),v(null),e},[]),E=(0,o.useCallback)(async()=>{let{refresh:e}=y();try{let r=await (0,a.sg)("/api/auth/refresh",e?{refreshToken:e}:{});if(null==r?void 0:r.accessToken){var t,n;return w(r.accessToken,null!==(n=null!==(t=r.refreshToken)&&void 0!==t?t:e)&&void 0!==n?n:null),g(r.accessToken),!0}return!1}catch(e){return T(),!1}},[T,y,w]),P=(0,o.useCallback)(async(e,t)=>{v(null),d("authenticating");try{let r=await (0,a.sg)("/api/auth/login",{email:e,password:t});if(null==r?void 0:r.accessToken){var n;w(r.accessToken,null!==(n=r.refreshToken)&&void 0!==n?n:null),g(r.accessToken)}let o=(null==r?void 0:r.user)?r.user:await k();c(o),d("authenticated")}catch(e){throw v((null==e?void 0:e.message)||"Login failed"),d("unauthenticated"),T(),e}},[k,w,T]),I=(0,o.useCallback)(async()=>{try{let{refresh:e}=y();await (0,a.sg)("/api/auth/logout",e?{refreshToken:e}:{})}finally{T(),c(null),d("unauthenticated")}},[T,y]);(0,o.useEffect)(()=>{let e=!1;return(async()=>{d("authenticating");try{let{access:t}=y(),n=!!t;n?g(t||null):n=await E(),n?(await k(),e||d("authenticated")):e||(d("unauthenticated"),c(null))}catch(t){e||(v((null==t?void 0:t.message)||"Session expired. Please login again."),d("unauthenticated"),c(null),T())}})(),()=>{e=!0}},[E,k,T,y]);let b=(0,o.useMemo)(()=>({user:n,loading:p,status:h,error:f,login:P,logout:I,accessToken:m}),[n,p,h,f,P,I,m]);return(0,r.jsx)(s.Provider,{value:b,children:t})},h=()=>{let e=(0,o.useContext)(s);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},1695:function(e,t,n){"use strict";var r=n(1219);n.o(r,"useParams")&&n.d(t,{useParams:function(){return r.useParams}}),n.o(r,"usePathname")&&n.d(t,{usePathname:function(){return r.usePathname}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})},4859:function(e,t,n){"use strict";var r,o;e.exports=(null==(r=n.g.process)?void 0:r.env)&&"object"==typeof(null==(o=n.g.process)?void 0:o.env)?n.g.process:n(9566)},9566:function(e){!function(){var t={229:function(e){var t,n,r,o=e.exports={};function a(){throw Error("setTimeout has not been defined")}function s(){throw Error("clearTimeout has not been defined")}function u(e){if(t===setTimeout)return setTimeout(e,0);if((t===a||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:a}catch(e){t=a}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var i=[],l=!1,c=-1;function h(){l&&r&&(l=!1,r.length?i=r.concat(i):c=-1,i.length&&d())}function d(){if(!l){var e=u(h);l=!0;for(var t=i.length;t;){for(r=i,i=[];++c<t;)r&&r[c].run();c=-1,t=i.length}r=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function v(){}o.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];i.push(new f(e,t)),1!==i.length||l||u(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=v,o.addListener=v,o.once=v,o.off=v,o.removeListener=v,o.removeAllListeners=v,o.emit=v,o.prependListener=v,o.prependOnceListener=v,o.listeners=function(e){return[]},o.binding=function(e){throw Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw Error("process.chdir is not supported")},o.umask=function(){return 0}}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var a=n[e]={exports:{}},s=!0;try{t[e](a,a.exports,r),s=!1}finally{s&&delete n[e]}return a.exports}r.ab="//";var o=r(229);e.exports=o}()}},function(e){e.O(0,[293,914,744],function(){return e(e.s=4776)}),_N_E=e.O()}]);