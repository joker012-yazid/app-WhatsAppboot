(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{3924:function(e,s,t){Promise.resolve().then(t.bind(t,9079))},9079:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return C}});var a=t(7573),r=t(294),l=t(7653),n=t(8623),i=t(5731),d=t(5015),o=t(54),c=t(1883),u=t(1465),x=t(8325),m=t(4737),h=t(2628),p=t(3638),f=t(466),g=t(5036);let b={status:null,chats:[],selectedChatId:null,messages:[],filter:"all",loadingStatus:!1,loadingChats:!1,loadingMessages:!1,sending:!1};var v=t(1799),y=t(9147);let j=[{key:"all",label:"All"},{key:"unread",label:"Unread"},{key:"groups",label:"Groups"}],N=new Intl.DateTimeFormat(void 0,{hour:"numeric",minute:"2-digit"}),w=e=>e?N.format(new Date(e)):"",k=e=>e.split(" ").map(e=>e[0]).join("").slice(0,2).toUpperCase();function C(){var e;let{user:s}=(0,v.a)(),t=(0,p.p)(),[N,C]=(0,l.useState)("list"),[S,I]=(0,l.useState)(""),[z,A]=(0,l.useState)(""),R=(0,l.useRef)(null),{status:W,chats:M,allChats:Z,filter:E,messages:L,selectedChat:_,selectedChatId:D,selectChat:O,sendMessage:Q,setFilter:q,startSession:B,resetSession:F,loadingStatus:P,sending:T}=function(){var e;let[s,t]=(0,l.useState)(b),a=(0,l.useRef)(null),r=(0,l.useRef)(null),n=(0,l.useCallback)(async()=>{t(e=>({...e,loadingStatus:!0}));try{let e=await (0,g.ML)();console.debug("[WhatsApp][status]",e),t(s=>({...s,status:e,loadingStatus:!1}))}catch(e){console.error("[WhatsApp][status] error",e),t(s=>({...s,loadingStatus:!1,status:{status:"error",qrImage:null,hasQR:!1,lastError:null==e?void 0:e.message}}))}},[]),i=(0,l.useCallback)(async e=>{t(e=>({...e,loadingStatus:!0}));try{let s=await (0,g.wi)(e);console.debug("[WhatsApp][init]",s)}catch(e){console.error("[WhatsApp][init] error",e)}finally{await n()}},[n]),d=(0,l.useCallback)(async()=>{t(e=>({...e,loadingStatus:!0,chats:[],messages:[],selectedChatId:null}));try{let e=await (0,g.BX)();console.debug("[WhatsApp][reset]",e)}catch(e){console.error("[WhatsApp][reset] error",e)}finally{await n()}},[n]),o=(0,l.useCallback)(async()=>{t(e=>({...e,loadingChats:!0}));try{let{chats:e}=await (0,g.fk)();console.debug("[WhatsApp][chats]",e),t(s=>({...s,chats:e,loadingChats:!1}))}catch(e){throw t(e=>({...e,loadingChats:!1})),e}},[]),c=(0,l.useCallback)(async e=>{t(e=>({...e,loadingMessages:!0}));try{let{messages:s}=await (0,g.vh)(e);console.debug("[WhatsApp][messages]",e,s.length),t(e=>({...e,messages:s,loadingMessages:!1}))}catch(e){throw t(e=>({...e,loadingMessages:!1})),e}},[]),u=(0,l.useCallback)(e=>{t(s=>({...s,selectedChatId:e})),c(e).catch(()=>{})},[c]),x=(0,l.useCallback)(async e=>{let a=e.trim();if(!a||!s.selectedChatId)return!1;t(e=>({...e,sending:!0}));try{return await (0,g.iL)(s.selectedChatId,a),await c(s.selectedChatId),await o(),!0}finally{t(e=>({...e,sending:!1}))}},[o,c,s.selectedChatId]);(0,l.useEffect)(()=>(n(),()=>{a.current&&clearInterval(a.current),r.current&&clearInterval(r.current)}),[n]),(0,l.useEffect)(()=>(a.current&&clearInterval(a.current),a.current=setInterval(()=>{t(e=>e),n()},4e3),()=>{a.current&&clearInterval(a.current)}),[n]),(0,l.useEffect)(()=>{var e;if((null===(e=s.status)||void 0===e?void 0:e.status)!=="connected"){r.current&&clearInterval(r.current);return}return o(),r.current&&clearInterval(r.current),r.current=setInterval(()=>{o()},12e3),()=>{r.current&&clearInterval(r.current)}},[o,null===(e=s.status)||void 0===e?void 0:e.status]);let m=(0,l.useMemo)(()=>s.chats.filter(e=>"unread"===s.filter?e.unreadCount>0:"groups"!==s.filter||e.isGroup),[s.chats,s.filter]);return{...s,chats:m,allChats:s.chats,selectedChat:s.chats.find(e=>e.id===s.selectedChatId)||null,setFilter:e=>t(s=>({...s,filter:e})),refreshStatus:n,startSession:i,resetSession:d,loadChats:o,selectChat:u,sendMessage:x}}(),U=(0,l.useMemo)(()=>{let e=(null==W?void 0:W.status)||"disconnected";return"connected"===e?{label:"Connected",className:"bg-emerald-500/15 text-emerald-300 border-emerald-500/40"}:"qr_ready"===e?{label:"Scan QR",className:"bg-amber-500/15 text-amber-300 border-amber-500/40"}:"connecting"===e?{label:"Connecting",className:"bg-sky-500/15 text-sky-300 border-sky-500/40"}:"error"===e?{label:"Error",className:"bg-rose-500/15 text-rose-300 border-rose-500/40"}:{label:"Disconnected",className:"bg-slate-700/30 text-slate-200 border-slate-600/50"}},[null==W?void 0:W.status]),G=M.filter(e=>{var s,t;if(!S.trim())return!0;let a=S.toLowerCase();return e.name.toLowerCase().includes(a)||(null===(t=e.lastMessage)||void 0===t?void 0:null===(s=t.text)||void 0===s?void 0:s.toLowerCase().includes(a))});(0,l.useEffect)(()=>{var e;null===(e=R.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[L,D]);let K=e=>{O(e),C("chat")},X=async()=>{if(!D){t.info("Select a chat to start messaging");return}try{await Q(z)&&A("")}catch(e){t.error((null==e?void 0:e.message)||"Failed to send message")}},V=(null==W?void 0:W.status)==="qr_ready"&&(null==W?void 0:W.qrImage),H=(null==W?void 0:W.status)==="connected";return(0,a.jsx)(h.Z,{children:(0,a.jsxs)("section",{className:"flex h-[calc(100vh-180px)] flex-col overflow-hidden rounded-xl border bg-gradient-to-br from-slate-950/90 via-slate-900/80 to-slate-950/60 px-4 py-5 shadow-lg shadow-black/40 backdrop-blur",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3 border-b border-slate-800/60 pb-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-xs uppercase tracking-[0.35em] text-slate-400",children:"WhatsApp"}),(0,a.jsx)("h1",{className:"text-2xl font-semibold text-slate-50",children:"WhatsApp Control Room"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Monitor and reply WhatsApp messages via Baileys."})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:(0,y.cn)("rounded-full border px-3 py-1 text-xs font-semibold",U.className),children:U.label}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(f.z,{size:"sm",variant:"outline",onClick:()=>B(!1),disabled:P,children:[(0,a.jsx)(n.Z,{className:"mr-2 h-4 w-4"}),"Start Session"]}),(0,a.jsx)(f.z,{size:"sm",variant:"ghost",onClick:()=>F(),disabled:P,children:"Reset"})]})]})]}),(0,a.jsxs)("div",{className:"mt-4 flex flex-1 min-h-0 gap-4",children:[(0,a.jsxs)("aside",{className:(0,y.cn)("rounded-lg border border-slate-800 bg-slate-950/70 shadow-sm transition-all duration-300","list"===N?"flex w-full flex-col":"hidden","md:flex md:w-[360px] md:flex-col"),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between px-4 py-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-xs uppercase tracking-[0.25em] text-muted-foreground",children:"Chats"}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:"Linked with Baileys session"})]}),(0,a.jsx)("span",{className:"rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-medium text-emerald-500",children:H?"Live":"Idle"})]}),(0,a.jsxs)("div",{className:"space-y-3 px-4 pb-4",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(i.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground",size:16}),(0,a.jsx)("input",{value:S,onChange:e=>I(e.target.value),placeholder:"Search conversations",className:"w-full rounded-lg border border-border bg-background/80 px-10 py-2 text-sm outline-none ring-0 transition focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:j.map(e=>(0,a.jsx)("button",{type:"button",onClick:()=>q(e.key),className:(0,y.cn)("rounded-full border px-3 py-1 text-xs font-medium transition",E===e.key?"border-primary bg-primary/10 text-primary":"border-border text-muted-foreground hover:border-primary/40 hover:text-foreground"),children:e.label},e.key))})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto px-2 pb-4",children:0===G.length?(0,a.jsx)("div",{className:"rounded-lg border border-dashed border-border/60 px-4 py-10 text-center text-sm text-muted-foreground",children:"No conversations found."}):(0,a.jsx)("div",{className:"space-y-1",children:G.map(e=>{var s,t;let r=e.id===D;return(0,a.jsxs)("button",{type:"button",onClick:()=>K(e.id),className:(0,y.cn)("group flex w-full items-center gap-3 rounded-lg px-3 py-3 text-left transition",r?"bg-sky-500/10 ring-1 ring-sky-500/40":"hover:bg-muted/60"),children:[(0,a.jsx)("div",{className:"flex h-11 w-11 items-center justify-center rounded-full bg-primary/10 text-sm font-semibold text-primary",children:k(e.name)}),(0,a.jsx)("div",{className:"min-w-0 flex-1",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,a.jsx)("p",{className:"truncate text-sm font-semibold",children:e.name}),(0,a.jsx)("p",{className:"truncate text-xs text-muted-foreground",children:(null===(s=e.lastMessage)||void 0===s?void 0:s.text)||"No messages yet"})]}),(0,a.jsxs)("div",{className:"flex shrink-0 flex-col items-end gap-1",children:[(0,a.jsx)("span",{className:"text-[11px] text-muted-foreground",children:(null===(t=e.lastMessage)||void 0===t?void 0:t.timestamp)?w(e.lastMessage.timestamp):""}),e.unreadCount>0?(0,a.jsx)("span",{className:"inline-flex min-w-[24px] justify-center rounded-full bg-primary px-2 py-0.5 text-[11px] font-semibold text-primary-foreground",children:e.unreadCount}):null]})]})})]},e.id)})})})]}),(0,a.jsx)("div",{className:(0,y.cn)("flex flex-1 flex-col rounded-lg border border-slate-800 bg-slate-950/80 shadow-sm","chat"===N?"flex":"hidden","md:flex"),children:V?(0,a.jsx)("div",{className:"flex flex-1 items-center justify-center px-6",children:(0,a.jsxs)("div",{className:"flex w-full max-w-xl flex-col items-center gap-4 rounded-2xl border border-slate-800 bg-slate-900/70 px-8 py-8 text-center shadow-sm backdrop-blur",children:[(0,a.jsx)("div",{className:"text-sm font-semibold text-slate-100",children:"Scan to link WhatsApp"}),(0,a.jsx)("div",{className:"overflow-hidden rounded-xl border border-slate-800 bg-black/20 shadow",children:(0,a.jsx)(r.default,{src:W.qrImage,alt:"WhatsApp QR",width:260,height:260})}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Open WhatsApp on your phone → Linked devices → Link a device. Scan this QR to continue."}),(0,a.jsxs)(f.z,{variant:"outline",onClick:()=>B(!0),disabled:P,children:[(0,a.jsx)(n.Z,{className:"mr-2 h-4 w-4"}),"Refresh QR"]})]})}):(null==W?void 0:W.status)!=="connected"?(0,a.jsx)("div",{className:"flex flex-1 items-center justify-center px-6",children:(0,a.jsxs)("div",{className:"flex max-w-md flex-col items-center gap-3 rounded-2xl border border-slate-800 bg-slate-900/70 px-8 py-10 text-center shadow-sm backdrop-blur",children:[(0,a.jsx)("div",{className:"rounded-full bg-primary/10 p-4 text-primary",children:(0,a.jsx)(d.Z,{size:36})}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-slate-50",children:"Start WhatsApp Session"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Initialize Baileys and scan the QR to sync messages to your control room."}),(null==W?void 0:W.status)==="error"&&W.lastError?(0,a.jsxs)("div",{className:"flex items-center gap-2 rounded-md border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-xs text-rose-200",children:[(0,a.jsx)(o.Z,{className:"h-4 w-4"})," ",W.lastError]}):null,(0,a.jsxs)(f.z,{onClick:()=>B(!1),disabled:P,children:[(0,a.jsx)(n.Z,{className:"mr-2 h-4 w-4"}),"Start Session"]})]})}):_?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"sticky top-0 z-10 flex items-center justify-between gap-3 border-b border-slate-800 bg-slate-950/80 px-6 py-4 backdrop-blur",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(f.z,{variant:"ghost",size:"icon",className:"md:hidden",onClick:()=>C("list"),children:(0,a.jsx)(c.Z,{size:18})}),(0,a.jsx)("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-base font-semibold text-primary",children:k(_.name)}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-lg font-semibold leading-tight text-slate-50",children:_.name}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:"WhatsApp chat"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1 text-muted-foreground",children:[(0,a.jsx)("button",{type:"button",className:"rounded-full p-2 transition hover:bg-muted hover:text-foreground",children:(0,a.jsx)(i.Z,{size:18})}),(0,a.jsx)("button",{type:"button",className:"rounded-full p-2 transition hover:bg-muted hover:text-foreground",children:(0,a.jsx)(u.Z,{size:18})})]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:(0,a.jsxs)("div",{className:"flex flex-col space-y-2",children:[L.map(e=>{let s=e.fromMe;return(0,a.jsx)("div",{className:(0,y.cn)("flex flex-col",s?"items-end":"items-start"),children:(0,a.jsxs)("div",{className:(0,y.cn)("max-w-[70%] rounded-2xl px-4 py-2 text-sm shadow-sm transition",s?"ml-auto bg-sky-500 text-slate-950":"bg-slate-800 text-slate-50"),children:[(0,a.jsx)("p",{className:"leading-relaxed",children:e.text}),(0,a.jsx)("span",{className:"mt-1 block text-[10px] text-slate-400",children:w(e.timestamp)})]})},e.id)}),(0,a.jsx)("div",{ref:R})]})}),(0,a.jsx)("form",{onSubmit:e=>{e.preventDefault(),X()},className:"border-t border-slate-800 bg-slate-950/95 px-4 py-3",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition hover:bg-muted hover:text-foreground",children:(0,a.jsx)(x.Z,{size:18})}),(0,a.jsx)("textarea",{value:z,onChange:e=>A(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),X())},placeholder:"Type a message",rows:1,className:"min-h-[44px] max-h-28 flex-1 resize-none rounded-lg border border-border bg-background/80 px-3 py-2 text-sm outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20"}),(0,a.jsx)(f.z,{type:"submit",size:"icon",className:"h-11 w-11",disabled:!z.trim()||T,children:(0,a.jsx)(m.Z,{size:18})})]})})]}):(0,a.jsx)("div",{className:"flex flex-1 items-center justify-center px-6",children:(0,a.jsxs)("div",{className:"flex max-w-lg flex-col items-center gap-4 rounded-2xl border border-slate-800 bg-slate-900/70 px-10 py-12 text-center shadow-sm backdrop-blur",children:[(0,a.jsx)("div",{className:"rounded-full bg-primary/10 p-4 text-primary",children:(0,a.jsx)(d.Z,{size:42})}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("h2",{className:"text-2xl font-semibold",children:"Select a chat to start messaging"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Pick a conversation from the left to view history and send replies."})]}),(0,a.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Authenticated as ",(0,a.jsx)("span",{className:"font-semibold text-foreground",children:null!==(e=null==s?void 0:s.email)&&void 0!==e?e:"unknown"}),(null==s?void 0:s.role)?" (".concat(s.role,")"):null]})]})})})]})]})})}},2628:function(e,s,t){"use strict";t.d(s,{Z:function(){return i}});var a=t(7573),r=t(1695),l=t(7653),n=t(1799);function i(e){let{children:s,redirectOnFail:t=!0}=e,{user:i,loading:d,error:o,status:c}=(0,n.a)(),u=(0,r.useRouter)();return((0,l.useEffect)(()=>{if(t&&!d&&(!i||o||"unauthenticated"===c)){let e=o?"?reason=".concat(encodeURIComponent(o)):"";u.replace("/login".concat(e))}},[i,d,o,u,t,c]),d)?(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading session..."}):!i&&t?null:(0,a.jsx)(a.Fragment,{children:s})}},5036:function(e,s,t){"use strict";t.d(s,{BX:function(){return n},ML:function(){return l},fk:function(){return i},iL:function(){return o},vh:function(){return d},wi:function(){return r}});var a=t(5118);async function r(e){return(0,a.SC)("/api/whatsapp/session/init",{method:"POST",body:{forceNewSession:e}})}async function l(){return(0,a.SC)("/api/whatsapp/session/status")}async function n(){return(0,a.SC)("/api/whatsapp/session/reset",{method:"POST"})}async function i(){return(0,a.SC)("/api/whatsapp/chats")}async function d(e){return(0,a.SC)("/api/whatsapp/chats/".concat(encodeURIComponent(e),"/messages"))}async function o(e,s){await (0,a.SC)("/api/whatsapp/chats/"+encodeURIComponent(e)+"/messages",{method:"POST",body:{text:s}})}}},function(e){e.O(0,[322,422,293,914,744],function(){return e(e.s=3924)}),_N_E=e.O()}]);