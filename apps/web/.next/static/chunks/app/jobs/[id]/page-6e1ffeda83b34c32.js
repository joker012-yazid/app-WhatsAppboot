(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[712],{9581:function(e,t,s){Promise.resolve().then(s.bind(s,3291))},3291:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return g}});var n=s(7573),a=s(8146),l=s(1695),r=s(7653),i=s(7930),o=s(1988),d=s(5969),c=s(2628),u=s(5118),m=s(3638),x=s(957),p=s(466),h=s(1799),b=s(327);function g(){var e,t;let{id:s}=(0,l.useParams)(),g=(0,l.useRouter)(),v=(0,i.NL)(),j=(0,m.p)(),N=(0,x.N)(),{user:y}=(0,h.a)(),A=(0,o.a)({queryKey:["job",s],queryFn:async()=>(0,u.R1)("/api/jobs/".concat(s))}),E=null===(e=A.data)||void 0===e?void 0:e.job,C=(null===(t=A.data)||void 0===t?void 0:t.qr_url)||"",[D,w]=(0,r.useState)("PENDING"),[k,S]=(0,r.useState)("NORMAL"),[I,R]=(0,r.useState)(""),[P,T]=(0,r.useState)(""),[M,F]=(0,r.useState)(null),L=()=>{E&&(w(E.status),S(E.priority),R(E.dueDate?E.dueDate.substring(0,16):""),T(E.diagnosis||""))};(0,r.useMemo)(()=>{L()},[null==E?void 0:E.id]);let G=(0,d.D)({mutationFn:async()=>(0,u.pE)("/api/jobs/".concat(s),{status:D,priority:k,dueDate:I?new Date(I).toISOString():null,diagnosis:P}),onSuccess:async()=>{await v.invalidateQueries({queryKey:["job",s]}),await v.invalidateQueries({queryKey:["jobs"]}),j.success("Job updated")},onError:e=>F((null==e?void 0:e.message)||"Failed to update job")}),{data:q}=(0,o.a)({queryKey:["job-history",s],queryFn:async()=>(0,u.R1)("/api/jobs/".concat(s,"/history"))}),O=(0,d.D)({mutationFn:async()=>(0,u.sg)("/api/jobs/".concat(s,"/qr/renew"),{}),onSuccess:async()=>{await v.invalidateQueries({queryKey:["job",s]}),j.success("QR reissued")}}),{data:z,refetch:H}=(0,o.a)({queryKey:["job-photos",s],queryFn:async()=>(0,u.R1)("/api/jobs/".concat(s,"/photos"))}),[Q,K]=(0,r.useState)(""),[U,_]=(0,r.useState)(null),[B,J]=(0,r.useState)(null),W=(0,d.D)({mutationFn:async()=>{if(!U||0===U.length)throw Error("Select file(s)");let e=new FormData;return U.forEach(t=>e.append("photos",t)),Q&&e.append("label",Q),(0,u.zi)("/api/jobs/".concat(s,"/photos"),e)},onSuccess:async e=>{var t,s,n;K(""),_(null),(null===(t=document.getElementById("photo-input"))||void 0===t?void 0:t.value)&&(document.getElementById("photo-input").value=""),await H(),j.success("Uploaded ".concat(null!==(n=null!==(s=null==e?void 0:e.length)&&void 0!==s?s:null==U?void 0:U.length)&&void 0!==n?n:0," photo(s)"))},onError:e=>{let t=(null==e?void 0:e.message)||"Failed to upload";J(t),j.error(t)}}),Z=(0,d.D)({mutationFn:async e=>(0,u.QW)("/api/jobs/".concat(s,"/photos/").concat(e)),onSuccess:async()=>{await H(),j.success("Photo deleted")}}),V=(0,d.D)({mutationFn:async()=>(0,u.QW)("/api/jobs/".concat(s)),onSuccess:async()=>{await v.invalidateQueries({queryKey:["jobs"]}),j.success("Job deleted"),g.replace("/jobs")},onError:e=>j.error((null==e?void 0:e.message)||"Failed to delete job")});return(0,n.jsx)(c.Z,{children:(0,n.jsxs)("section",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-xs uppercase tracking-[0.35em] text-muted-foreground",children:"Job Detail"}),(0,n.jsx)("h1",{className:"text-2xl font-semibold",children:(null==E?void 0:E.title)||"Loading…"}),E?(0,n.jsxs)("p",{className:"text-sm text-muted-foreground",children:[E.customer.name," • ",[E.device.deviceType,E.device.brand,E.device.model].filter(Boolean).join(" ")]}):null]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(p.z,{variant:"outline",asChild:!0,children:(0,n.jsx)(a.default,{href:"/jobs",children:"Back"})}),(0,n.jsx)(p.z,{variant:"destructive",onClick:async()=>{await N({title:"Delete job",description:"Are you sure you want to delete this job? This action cannot be undone.",confirmText:"Delete",variant:"destructive"})&&V.mutate()},disabled:V.isPending,children:"Delete"})]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-3",children:[(0,n.jsxs)("div",{className:"md:col-span-2 space-y-4",children:[(0,n.jsxs)("div",{className:"rounded-xl border bg-card p-4",children:[(0,n.jsx)("h2",{className:"mb-3 text-lg font-semibold",children:"AI Assistant"}),(0,n.jsx)(f,{jobId:s})]}),(0,n.jsxs)("div",{className:"rounded-xl border bg-card p-4",children:[(0,n.jsx)("h2",{className:"mb-3 text-lg font-semibold",children:"QR Registration"}),C?(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsxs)("p",{className:"text-sm text-muted-foreground break-all",children:[(0,n.jsx)("span",{className:"font-medium",children:"URL:"})," ",C]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(p.z,{type:"button",onClick:()=>{var e;null===(e=navigator.clipboard)||void 0===e||e.writeText(C)},children:"Copy link"}),(0,n.jsx)(p.z,{asChild:!0,variant:"outline",children:(0,n.jsx)("a",{href:C,target:"_blank",rel:"noreferrer",children:"Open link"})}),(0,b.A)(null==y?void 0:y.role,["ADMIN","MANAGER","TECHNICIAN"])?(0,n.jsx)(p.z,{variant:"secondary",type:"button",onClick:()=>O.mutate(),disabled:O.isPending,children:O.isPending?"Reissuing…":"Reissue QR"}):null]}),(0,n.jsx)("p",{className:"text-xs text-muted-foreground",children:"Share this link with the customer to complete registration."})]}):(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading QR link…"})]}),(0,n.jsxs)("div",{className:"rounded-xl border bg-card p-4",children:[(0,n.jsx)("h2",{className:"mb-3 text-lg font-semibold",children:"Photos"}),(0,n.jsxs)("form",{className:"mb-4 grid grid-cols-1 gap-3 md:grid-cols-3",onSubmit:e=>{e.preventDefault(),J(null),W.mutate()},children:[(0,n.jsx)("input",{id:"photo-input",type:"file",accept:"image/*",multiple:!0,onChange:e=>{let t=Array.from(e.target.files||[]);if(t.length>6){_(null),J("Select up to ".concat(6," files")),e.target.value="";return}if(t.find(e=>!e.type.startsWith("image/")||e.size>5242880)){_(null),J("Only images up to 5 MB each are allowed"),e.target.value="";return}J(null),_(t)},className:"md:col-span-2"}),(0,n.jsx)("input",{type:"text",placeholder:"Label (optional)",value:Q,onChange:e=>K(e.target.value),className:"rounded-md border border-input bg-transparent px-3 py-2 text-sm"}),(0,n.jsxs)("div",{className:"md:col-span-3",children:[(0,n.jsx)("p",{className:"mb-2 text-xs text-muted-foreground",children:"PNG/JPG/WebP up to 5 MB each. Max 6 files."}),B?(0,n.jsx)("p",{className:"mb-2 text-sm text-red-500",children:B}):null,(0,n.jsx)(p.z,{type:"submit",disabled:W.isPending||!U||0===U.length||!!B||!(0,b.A)(null==y?void 0:y.role,["ADMIN","MANAGER","TECHNICIAN"]),children:W.isPending?"Uploading…":"Upload"})]})]}),z?0===z.length?(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"No photos yet."}):(0,n.jsx)("div",{className:"grid grid-cols-2 gap-3 md:grid-cols-3",children:z.map(e=>(0,n.jsxs)("figure",{className:"space-y-1",children:[(0,n.jsx)("img",{src:e.url,alt:e.label||"Job photo",className:"h-40 w-full rounded-md object-cover"}),(0,n.jsxs)("figcaption",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[(0,n.jsx)("span",{className:"truncate",children:e.label||"—"}),(0,b.A)(null==y?void 0:y.role,["ADMIN","MANAGER","TECHNICIAN"])?(0,n.jsx)("button",{className:"rounded border px-2 py-0.5",onClick:async()=>{await N({title:"Delete photo",description:"Are you sure you want to delete this photo?",confirmText:"Delete",variant:"destructive"})&&Z.mutate(e.id)},disabled:Z.isPending,children:"Delete"}):null]})]},e.id))}):(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading…"})]}),(0,n.jsxs)("div",{className:"rounded-xl border bg-card p-4",children:[(0,n.jsx)("h2",{className:"mb-3 text-lg font-semibold",children:"Status & Scheduling"}),(0,n.jsxs)("form",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",onSubmit:e=>{e.preventDefault(),F(null),G.mutate()},children:[(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"status",children:"Status"}),(0,n.jsx)("select",{id:"status",value:D,onChange:e=>w(e.target.value),className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-foreground",disabled:!(0,b.A)(null==y?void 0:y.role,["ADMIN","MANAGER","TECHNICIAN"]),children:["PENDING","QUOTED","APPROVED","REJECTED","IN_PROGRESS","COMPLETED"].map(e=>(0,n.jsx)("option",{value:e,className:"bg-background text-foreground",children:e},e))})]}),(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"priority",children:"Priority"}),(0,n.jsx)("select",{id:"priority",value:k,onChange:e=>S(e.target.value),className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-foreground",disabled:!(0,b.A)(null==y?void 0:y.role,["ADMIN","MANAGER","TECHNICIAN"]),children:["LOW","NORMAL","HIGH","URGENT"].map(e=>(0,n.jsx)("option",{value:e,className:"bg-background text-foreground",children:e},e))})]}),(0,n.jsxs)("div",{className:"space-y-1 md:col-span-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"due",children:"Due date"}),(0,n.jsx)("input",{id:"due",type:"datetime-local",value:I,onChange:e=>R(e.target.value),className:"w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm",disabled:!(0,b.A)(null==y?void 0:y.role,["ADMIN","MANAGER","TECHNICIAN"])})]}),(0,n.jsxs)("div",{className:"space-y-1 md:col-span-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"diagnosis",children:"Diagnosis (optional)"}),(0,n.jsx)("textarea",{id:"diagnosis",value:P,onChange:e=>T(e.target.value),className:"h-24 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm",disabled:!(0,b.A)(null==y?void 0:y.role,["ADMIN","MANAGER","TECHNICIAN"])})]}),M?(0,n.jsx)("p",{className:"text-sm text-red-500 md:col-span-2",children:M}):null,(0,b.A)(null==y?void 0:y.role,["ADMIN","MANAGER","TECHNICIAN"])?(0,n.jsx)("div",{className:"md:col-span-2",children:(0,n.jsx)(p.z,{type:"submit",disabled:G.isPending,children:G.isPending?"Saving…":"Save changes"})}):null]})]})]}),(0,n.jsxs)("aside",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"rounded-xl border bg-card p-4",children:[(0,n.jsx)("h3",{className:"mb-2 text-sm font-semibold text-muted-foreground",children:"Meta"}),(0,n.jsxs)("ul",{className:"text-sm",children:[(0,n.jsxs)("li",{children:[(0,n.jsx)("span",{className:"text-muted-foreground",children:"Created:"})," ",E?new Date(E.createdAt).toLocaleString():"-"]}),(0,n.jsxs)("li",{children:[(0,n.jsx)("span",{className:"text-muted-foreground",children:"Status:"})," ",(null==E?void 0:E.status)||"-"]}),(0,n.jsxs)("li",{children:[(0,n.jsx)("span",{className:"text-muted-foreground",children:"Priority:"})," ",(null==E?void 0:E.priority)||"-"]})]})]}),(0,n.jsxs)("div",{className:"rounded-xl border bg-card p-4",children:[(0,n.jsx)("h3",{className:"mb-2 text-sm font-semibold text-muted-foreground",children:"Status History"}),q?0===q.length?(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"No changes yet."}):(0,n.jsx)("ul",{className:"space-y-2 text-sm",children:q.map(e=>(0,n.jsxs)("li",{className:"border-b pb-2 last:border-b-0",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("span",{className:"font-medium",children:e.status}),(0,n.jsx)("span",{className:"text-xs text-muted-foreground",children:new Date(e.createdAt).toLocaleString()})]}),e.notes?(0,n.jsx)("p",{className:"text-muted-foreground",children:e.notes}):null]},e.id))}):(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading…"})]})]})]})]})})}function f(e){let{jobId:t}=e,{data:s,refetch:a,isFetching:l}=(0,o.a)({queryKey:["ai-messages",t],queryFn:async()=>(0,u.R1)("/api/ai/job/".concat(t,"/messages"))}),i=(0,m.p)(),[c,x]=(0,r.useState)(""),h=(0,d.D)({mutationFn:async()=>(0,u.sg)("/api/ai/ask",{jobId:t,message:c}),onSuccess:async()=>{x(""),await a()},onError:e=>i.error((null==e?void 0:e.message)||"Failed to ask AI")});return(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsx)("div",{className:"max-h-64 space-y-2 overflow-auto rounded border p-3 text-sm",children:!s||l?(0,n.jsx)("p",{className:"text-muted-foreground",children:"Loading…"}):0===s.messages.length?(0,n.jsx)("p",{className:"text-muted-foreground",children:"No messages yet. Ask something about this job."}):s.messages.map(e=>(0,n.jsx)("div",{className:"USER"===e.role?"text-right":"text-left",children:(0,n.jsx)("span",{className:"inline-block rounded-md px-2 py-1 ".concat("USER"===e.role?"bg-primary text-primary-foreground":"bg-muted text-foreground"),children:e.content})},e.id))}),(0,n.jsxs)("form",{className:"flex items-center gap-2",onSubmit:e=>{e.preventDefault(),c.trim()&&h.mutate()},children:[(0,n.jsx)("input",{value:c,onChange:e=>x(e.target.value),placeholder:"Ask AI about this job…",className:"flex-1 rounded-md border border-input bg-transparent px-3 py-2 text-sm"}),(0,n.jsx)(p.z,{type:"submit",disabled:h.isPending||!c.trim(),children:h.isPending?"Sending…":"Send"})]})]})}},2628:function(e,t,s){"use strict";s.d(t,{Z:function(){return i}});var n=s(7573),a=s(1695),l=s(7653),r=s(1799);function i(e){let{children:t,redirectOnFail:s=!0}=e,{user:i,loading:o,error:d,status:c}=(0,r.a)(),u=(0,a.useRouter)();return((0,l.useEffect)(()=>{if(s&&!o&&(!i||d||"unauthenticated"===c)){let e=d?"?reason=".concat(encodeURIComponent(d)):"";u.replace("/login".concat(e))}},[i,o,d,u,s,c]),o)?(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading session..."}):!i&&s?null:(0,n.jsx)(n.Fragment,{children:t})}},957:function(e,t,s){"use strict";s.d(t,{N:function(){return o},W:function(){return i}});var n=s(7573),a=s(7653),l=s(3458);let r=(0,a.createContext)(void 0);function i(e){let{children:t}=e,[s,i]=(0,a.useState)(null),[o,d]=(0,a.useState)(!1),c=(0,a.useRef)(null),u=(0,a.useRef)(null),m=(0,a.useRef)(null);(0,a.useEffect)(()=>{d(!0)},[]);let x=(0,a.useCallback)(e=>new Promise(t=>{var s,n,a,l,r;i({id:Date.now(),resolve:t,title:null!==(s=e.title)&&void 0!==s?s:"Confirm action",description:null!==(n=e.description)&&void 0!==n?n:"Are you sure you want to proceed? This action cannot be undone.",confirmText:null!==(a=e.confirmText)&&void 0!==a?a:"Confirm",cancelText:null!==(l=e.cancelText)&&void 0!==l?l:"Cancel",variant:null!==(r=e.variant)&&void 0!==r?r:"default"})}),[]),p=(0,a.useMemo)(()=>({confirm:x}),[x]),h=(0,a.useCallback)(e=>{i(t=>(t&&t.resolve(e),null))},[]);(0,a.useEffect)(()=>{if(!s)return;c.current=document.activeElement||null;let e=setTimeout(()=>{var e;null===(e=u.current||m.current)||void 0===e||e.focus()},0),t=e=>{if(s){if("Escape"===e.key){e.preventDefault(),h(!1);return}if("Enter"===e.key){e.preventDefault(),h(!0);return}if("Tab"===e.key){let t=[m.current,u.current].filter(Boolean);if(0===t.length)return;let s=t.indexOf(document.activeElement);if(e.shiftKey){let n=s<=0?t[t.length-1]:t[s-1];e.preventDefault(),n.focus()}else{let n=-1===s||s>=t.length-1?t[0]:t[s+1];e.preventDefault(),n.focus()}}}};return document.addEventListener("keydown",t),()=>{clearTimeout(e),document.removeEventListener("keydown",t);try{var s;null===(s=c.current)||void 0===s||s.focus()}catch(e){}}},[s,h]);let b=o&&s?(0,n.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",role:"presentation",children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>h(!1)}),(0,n.jsxs)("div",{className:"relative z-10 w-full max-w-sm rounded-xl border border-slate-800 bg-slate-950/90 p-5 shadow-2xl shadow-black/40 outline-none backdrop-blur",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-title","aria-describedby":"confirm-desc",tabIndex:-1,children:[(0,n.jsx)("h3",{id:"confirm-title",className:"mb-1 text-lg font-semibold text-slate-50",children:s.title}),(0,n.jsx)("p",{id:"confirm-desc",className:"mb-4 text-sm text-slate-300",children:s.description}),(0,n.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,n.jsx)("button",{ref:m,className:"rounded-md border border-slate-700 px-3 py-1.5 text-sm text-slate-200 transition hover:border-slate-500 hover:bg-slate-900",onClick:()=>h(!1),children:s.cancelText}),(0,n.jsx)("button",{ref:u,className:"rounded-md px-3 py-1.5 text-sm text-white transition ".concat("destructive"===s.variant?"bg-red-600 hover:bg-red-700":"bg-sky-600 hover:bg-sky-500"),onClick:()=>h(!0),children:s.confirmText})]})]})]}):null;return(0,n.jsxs)(r.Provider,{value:p,children:[t,o&&"undefined"!=typeof document&&b?(0,l.createPortal)(b,document.body):null]})}function o(){let e=(0,a.useContext)(r);if(!e)throw Error("useConfirm must be used within ConfirmProvider");return e.confirm}},327:function(e,t,s){"use strict";s.d(t,{A:function(){return n}});let n=(e,t)=>!!e&&t.includes(e)},8146:function(e,t,s){"use strict";s.d(t,{default:function(){return a.a}});var n=s(6340),a=s.n(n)}},function(e){e.O(0,[340,362,485,422,293,914,744],function(){return e(e.s=9581)}),_N_E=e.O()}]);