(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[238],{3510:function(e,t,s){Promise.resolve().then(s.bind(s,4556))},4556:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return p}});var n=s(7573),l=s(8146),r=s(1695),a=s(7653),i=s(7930),d=s(1988),o=s(5969),c=s(2628),u=s(5118),m=s(466),x=s(3638),f=s(957),h=s(1799),v=s(327);function p(){var e,t;let{id:s}=(0,r.useParams)(),p=(0,r.useRouter)(),b=(0,i.NL)(),N=(0,d.a)({queryKey:["customer",s],queryFn:async()=>(0,u.R1)("/api/customers/".concat(s))}),{user:j}=(0,h.a)(),g=N.data,[y,A]=(0,a.useState)(""),[E,w]=(0,a.useState)(""),[C,k]=(0,a.useState)(""),[D,M]=(0,a.useState)(""),[R,T]=(0,a.useState)(null),S=(0,x.p)(),F=(0,f.N)();(0,a.useEffect)(()=>{g&&(A(g.name),w(g.phone),k(g.email||""),M(g.notes||""))},[null==g?void 0:g.id]);let P=(0,o.D)({mutationFn:async()=>(0,u.pE)("/api/customers/".concat(s),{name:y,phone:E,email:C,notes:D}),onSuccess:async()=>{await b.invalidateQueries({queryKey:["customer",s]}),await b.invalidateQueries({queryKey:["customers"]}),S.success("Customer updated")},onError:e=>{let t=(null==e?void 0:e.message)||"Failed to save";T(t),S.error(t)}}),I=(0,o.D)({mutationFn:async()=>(0,u.QW)("/api/customers/".concat(s)),onSuccess:async()=>{await b.invalidateQueries({queryKey:["customers"]}),S.success("Customer deleted"),p.replace("/customers")},onError:e=>{let t=(null==e?void 0:e.message)||"Failed to delete";T(t),S.error(t)}}),L=!!g&&((null===(e=g._count)||void 0===e?void 0:e.devices)||0)+((null===(t=g._count)||void 0===t?void 0:t.jobs)||0)>0;return(0,n.jsx)(c.Z,{children:(0,n.jsxs)("section",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-xs uppercase tracking-[0.35em] text-muted-foreground",children:"Customer Detail"}),(0,n.jsx)("h1",{className:"text-2xl font-semibold",children:g?g.name:"Loading…"}),g?(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:g.phone}):null]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(m.z,{variant:"outline",asChild:!0,children:(0,n.jsx)(l.default,{href:"/customers",children:"Back"})}),(0,v.A)(null==j?void 0:j.role,["ADMIN","MANAGER"])?(0,n.jsx)(m.z,{variant:"destructive",disabled:L||I.isPending,onClick:async()=>{await F({title:"Delete customer",description:"Are you sure you want to delete this customer? This action cannot be undone.",variant:"destructive",confirmText:"Delete"})&&I.mutate()},children:L?"Has records":"Delete"}):null]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-3",children:[(0,n.jsxs)("div",{className:"md:col-span-2 rounded-xl border bg-card p-4",children:[(0,n.jsx)("h2",{className:"mb-3 text-lg font-semibold",children:"Edit Customer"}),(0,v.A)(null==j?void 0:j.role,["ADMIN","MANAGER"])?null:(0,n.jsx)("p",{className:"mb-3 text-sm text-amber-700",children:"You have read-only access. Editing is restricted to Admin/Manager."}),L?(0,n.jsx)("p",{className:"mb-3 text-sm text-muted-foreground",children:"This customer has related records. You can update details but deletion is disabled."}):null,(0,n.jsxs)("form",{className:"space-y-3",onSubmit:e=>{e.preventDefault(),T(null),P.mutate()},children:[(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"name",children:"Name"}),(0,n.jsx)("input",{id:"name",value:y,onChange:e=>A(e.target.value),className:"w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm",required:!0,disabled:!(0,v.A)(null==j?void 0:j.role,["ADMIN","MANAGER"])})]}),(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"phone",children:"Phone"}),(0,n.jsx)("input",{id:"phone",value:E,onChange:e=>w(e.target.value),className:"w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm",required:!0,disabled:!(0,v.A)(null==j?void 0:j.role,["ADMIN","MANAGER"])})]})]}),(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"email",children:"Email"}),(0,n.jsx)("input",{id:"email",type:"email",value:C,onChange:e=>k(e.target.value),className:"w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm",disabled:!(0,v.A)(null==j?void 0:j.role,["ADMIN","MANAGER"])})]}),(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"notes",children:"Notes"}),(0,n.jsx)("input",{id:"notes",value:D,onChange:e=>M(e.target.value),className:"w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm",disabled:!(0,v.A)(null==j?void 0:j.role,["ADMIN","MANAGER"])})]}),R?(0,n.jsx)("p",{className:"text-sm text-red-500",children:R}):null,(0,v.A)(null==j?void 0:j.role,["ADMIN","MANAGER"])?(0,n.jsx)(m.z,{type:"submit",disabled:P.isPending,children:P.isPending?"Saving…":"Save changes"}):null]})]}),(0,n.jsxs)("aside",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"rounded-xl border bg-card p-4",children:[(0,n.jsx)("h3",{className:"mb-2 text-sm font-semibold text-muted-foreground",children:"Devices"}),g?0===g.devices.length?(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"No devices."}):(0,n.jsx)("ul",{className:"space-y-2 text-sm",children:g.devices.map(e=>(0,n.jsx)("li",{children:(0,n.jsx)(l.default,{href:"/devices/".concat(e.id),className:"underline hover:no-underline",children:[e.deviceType,e.brand,e.model].filter(Boolean).join(" ")})},e.id))}):(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading…"})]}),(0,n.jsxs)("div",{className:"rounded-xl border bg-card p-4",children:[(0,n.jsx)("h3",{className:"mb-2 text-sm font-semibold text-muted-foreground",children:"Jobs"}),g?0===g.jobs.length?(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"No jobs."}):(0,n.jsx)("ul",{className:"space-y-2 text-sm",children:g.jobs.map(e=>(0,n.jsxs)("li",{className:"flex items-center justify-between gap-2",children:[(0,n.jsx)(l.default,{href:"/jobs/".concat(e.id),className:"underline hover:no-underline",children:e.title}),(0,n.jsx)("span",{className:"text-xs text-muted-foreground",children:new Date(e.createdAt).toLocaleString()})]},e.id))}):(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading…"})]})]})]})]})})}},2628:function(e,t,s){"use strict";s.d(t,{Z:function(){return i}});var n=s(7573),l=s(1695),r=s(7653),a=s(1799);function i(e){let{children:t,redirectOnFail:s=!0}=e,{user:i,loading:d,error:o,status:c}=(0,a.a)(),u=(0,l.useRouter)();return((0,r.useEffect)(()=>{if(s&&!d&&(!i||o||"unauthenticated"===c)){let e=o?"?reason=".concat(encodeURIComponent(o)):"";u.replace("/login".concat(e))}},[i,d,o,u,s,c]),d)?(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading session..."}):!i&&s?null:(0,n.jsx)(n.Fragment,{children:t})}},957:function(e,t,s){"use strict";s.d(t,{N:function(){return d},W:function(){return i}});var n=s(7573),l=s(7653),r=s(3458);let a=(0,l.createContext)(void 0);function i(e){let{children:t}=e,[s,i]=(0,l.useState)(null),[d,o]=(0,l.useState)(!1),c=(0,l.useRef)(null),u=(0,l.useRef)(null),m=(0,l.useRef)(null);(0,l.useEffect)(()=>{o(!0)},[]);let x=(0,l.useCallback)(e=>new Promise(t=>{var s,n,l,r,a;i({id:Date.now(),resolve:t,title:null!==(s=e.title)&&void 0!==s?s:"Confirm action",description:null!==(n=e.description)&&void 0!==n?n:"Are you sure you want to proceed? This action cannot be undone.",confirmText:null!==(l=e.confirmText)&&void 0!==l?l:"Confirm",cancelText:null!==(r=e.cancelText)&&void 0!==r?r:"Cancel",variant:null!==(a=e.variant)&&void 0!==a?a:"default"})}),[]),f=(0,l.useMemo)(()=>({confirm:x}),[x]),h=(0,l.useCallback)(e=>{i(t=>(t&&t.resolve(e),null))},[]);(0,l.useEffect)(()=>{if(!s)return;c.current=document.activeElement||null;let e=setTimeout(()=>{var e;null===(e=u.current||m.current)||void 0===e||e.focus()},0),t=e=>{if(s){if("Escape"===e.key){e.preventDefault(),h(!1);return}if("Enter"===e.key){e.preventDefault(),h(!0);return}if("Tab"===e.key){let t=[m.current,u.current].filter(Boolean);if(0===t.length)return;let s=t.indexOf(document.activeElement);if(e.shiftKey){let n=s<=0?t[t.length-1]:t[s-1];e.preventDefault(),n.focus()}else{let n=-1===s||s>=t.length-1?t[0]:t[s+1];e.preventDefault(),n.focus()}}}};return document.addEventListener("keydown",t),()=>{clearTimeout(e),document.removeEventListener("keydown",t);try{var s;null===(s=c.current)||void 0===s||s.focus()}catch(e){}}},[s,h]);let v=d&&s?(0,n.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",role:"presentation",children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>h(!1)}),(0,n.jsxs)("div",{className:"relative z-10 w-full max-w-sm rounded-xl border border-slate-800 bg-slate-950/90 p-5 shadow-2xl shadow-black/40 outline-none backdrop-blur",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-title","aria-describedby":"confirm-desc",tabIndex:-1,children:[(0,n.jsx)("h3",{id:"confirm-title",className:"mb-1 text-lg font-semibold text-slate-50",children:s.title}),(0,n.jsx)("p",{id:"confirm-desc",className:"mb-4 text-sm text-slate-300",children:s.description}),(0,n.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,n.jsx)("button",{ref:m,className:"rounded-md border border-slate-700 px-3 py-1.5 text-sm text-slate-200 transition hover:border-slate-500 hover:bg-slate-900",onClick:()=>h(!1),children:s.cancelText}),(0,n.jsx)("button",{ref:u,className:"rounded-md px-3 py-1.5 text-sm text-white transition ".concat("destructive"===s.variant?"bg-red-600 hover:bg-red-700":"bg-sky-600 hover:bg-sky-500"),onClick:()=>h(!0),children:s.confirmText})]})]})]}):null;return(0,n.jsxs)(a.Provider,{value:f,children:[t,d&&"undefined"!=typeof document&&v?(0,r.createPortal)(v,document.body):null]})}function d(){let e=(0,l.useContext)(a);if(!e)throw Error("useConfirm must be used within ConfirmProvider");return e.confirm}},327:function(e,t,s){"use strict";s.d(t,{A:function(){return n}});let n=(e,t)=>!!e&&t.includes(e)},8146:function(e,t,s){"use strict";s.d(t,{default:function(){return l.a}});var n=s(6340),l=s.n(n)}},function(e){e.O(0,[340,362,485,422,293,914,744],function(){return e(e.s=3510)}),_N_E=e.O()}]);