(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1929],{40555:function(e,t,s){Promise.resolve().then(s.bind(s,99053))},99053:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return _}});var a=s(27573),r=s(50294),n=s(7653),l=s(83185),i=s(98882),c=s(17787),o=s(45015),d=s(25555),u=s(83989),m=s(87811),x=s(84355),h=s(88623),f=s(20054),p=s(68854),g=s(95731),b=s(61883),j=s(44005),v=s(31690),y=s(11465),N=s(91266),w=s(98325),C=s(25159),k=s(74737),S=s(44526),I=s(33571),Z=s(45036);let E={status:null,chats:[],selectedChatId:null,messages:[],filter:"all",loadingStatus:!1,loadingChats:!1,loadingMessages:!1,sending:!1};var A=s(41799),M=s(29147);let W=[{key:"all",label:"All",icon:(0,a.jsx)(o.Z,{className:"h-3.5 w-3.5"})},{key:"unread",label:"Unread",icon:(0,a.jsx)(d.Z,{className:"h-3.5 w-3.5"})},{key:"groups",label:"Groups",icon:(0,a.jsx)(u.Z,{className:"h-3.5 w-3.5"})}],R=new Intl.DateTimeFormat(void 0,{hour:"numeric",minute:"2-digit"}),L=e=>e?R.format(new Date(e)):"",O=e=>e.split(" ").map(e=>e[0]).join("").slice(0,2).toUpperCase();function _(){let{user:e}=(0,A.a)(),[t,s]=(0,n.useState)("list"),[d,u]=(0,n.useState)(""),[R,_]=(0,n.useState)(""),q=(0,n.useRef)(null),{status:D,chats:Q,filter:T,messages:z,selectedChat:F,selectedChatId:P,selectChat:U,sendMessage:B,setFilter:G,startSession:K,resetSession:X,loadingStatus:V,sending:H}=function(){var e;let[t,s]=(0,n.useState)(E),a=(0,n.useRef)(null),r=(0,n.useRef)(null),l=(0,n.useCallback)(async()=>{s(e=>({...e,loadingStatus:!0}));try{let e=await (0,Z.ML)();console.debug("[WhatsApp][status]",e),s(t=>({...t,status:e,loadingStatus:!1}))}catch(e){console.error("[WhatsApp][status] error",e),s(t=>({...t,loadingStatus:!1,status:{status:"error",qrImage:null,hasQR:!1,lastError:null==e?void 0:e.message}}))}},[]),i=(0,n.useCallback)(async e=>{s(e=>({...e,loadingStatus:!0}));try{let t=await (0,Z.wi)(e);console.debug("[WhatsApp][init]",t)}catch(e){console.error("[WhatsApp][init] error",e)}finally{await l()}},[l]),c=(0,n.useCallback)(async()=>{s(e=>({...e,loadingStatus:!0,chats:[],messages:[],selectedChatId:null}));try{let e=await (0,Z.BX)();console.debug("[WhatsApp][reset]",e)}catch(e){console.error("[WhatsApp][reset] error",e)}finally{await l()}},[l]),o=(0,n.useCallback)(async()=>{s(e=>({...e,loadingChats:!0}));try{let{chats:e}=await (0,Z.fk)();console.debug("[WhatsApp][chats]",e),s(t=>({...t,chats:e,loadingChats:!1}))}catch(e){throw s(e=>({...e,loadingChats:!1})),e}},[]),d=(0,n.useCallback)(async e=>{s(e=>({...e,loadingMessages:!0}));try{let{messages:t}=await (0,Z.vh)(e);console.debug("[WhatsApp][messages]",e,t.length),s(e=>({...e,messages:t,loadingMessages:!1}))}catch(e){throw s(e=>({...e,loadingMessages:!1})),e}},[]),u=(0,n.useCallback)(e=>{s(t=>({...t,selectedChatId:e})),d(e).catch(()=>{})},[d]),m=(0,n.useCallback)(async e=>{let a=e.trim();if(!a||!t.selectedChatId)return!1;s(e=>({...e,sending:!0}));try{return await (0,Z.iL)(t.selectedChatId,a),await d(t.selectedChatId),await o(),!0}finally{s(e=>({...e,sending:!1}))}},[o,d,t.selectedChatId]);(0,n.useEffect)(()=>(l(),()=>{a.current&&clearInterval(a.current),r.current&&clearInterval(r.current)}),[l]),(0,n.useEffect)(()=>(a.current&&clearInterval(a.current),a.current=setInterval(()=>{s(e=>e),l()},4e3),()=>{a.current&&clearInterval(a.current)}),[l]),(0,n.useEffect)(()=>{var e;if((null===(e=t.status)||void 0===e?void 0:e.status)!=="connected"){r.current&&clearInterval(r.current);return}return o(),r.current&&clearInterval(r.current),r.current=setInterval(()=>{o()},12e3),()=>{r.current&&clearInterval(r.current)}},[o,null===(e=t.status)||void 0===e?void 0:e.status]);let x=(0,n.useMemo)(()=>t.chats.filter(e=>"unread"===t.filter?e.unreadCount>0:"groups"!==t.filter||e.isGroup),[t.chats,t.filter]);return{...t,chats:x,allChats:t.chats,selectedChat:t.chats.find(e=>e.id===t.selectedChatId)||null,setFilter:e=>s(t=>({...t,filter:e})),refreshStatus:l,startSession:i,resetSession:c,loadChats:o,selectChat:u,sendMessage:m}}(),J=(0,n.useMemo)(()=>{let e=(null==D?void 0:D.status)||"disconnected";return"connected"===e?{label:"Connected",color:"bg-green-500",icon:(0,a.jsx)(m.Z,{className:"h-3.5 w-3.5"})}:"qr_ready"===e?{label:"Scan QR",color:"bg-amber-500",icon:(0,a.jsx)(x.Z,{className:"h-3.5 w-3.5"})}:"connecting"===e?{label:"Connecting",color:"bg-blue-500 animate-pulse",icon:(0,a.jsx)(h.Z,{className:"h-3.5 w-3.5 animate-spin"})}:"error"===e?{label:"Error",color:"bg-red-500",icon:(0,a.jsx)(f.Z,{className:"h-3.5 w-3.5"})}:{label:"Offline",color:"bg-slate-500",icon:(0,a.jsx)(p.Z,{className:"h-3.5 w-3.5"})}},[null==D?void 0:D.status]),Y=Q.filter(e=>{var t,s;if(!d.trim())return!0;let a=d.toLowerCase();return e.name.toLowerCase().includes(a)||(null===(s=e.lastMessage)||void 0===s?void 0:null===(t=s.text)||void 0===t?void 0:t.toLowerCase().includes(a))});(0,n.useEffect)(()=>{var e;null===(e=q.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[z,P]);let $=e=>{U(e),s("chat")},ee=async()=>{if(!P){c.Am.info("Select a chat to start messaging");return}if(R.trim())try{await B(R)&&_("")}catch(e){c.Am.error((null==e?void 0:e.message)||"Failed to send message")}},et=(null==D?void 0:D.status)==="qr_ready"&&(null==D?void 0:D.qrImage),es=(null==D?void 0:D.status)==="connected";return(0,a.jsxs)("div",{className:"flex h-[calc(100vh-8rem)] flex-col gap-4",children:[(0,a.jsxs)(l.E.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex flex-wrap items-center justify-between gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:"WhatsApp Chat"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Monitor and reply to WhatsApp messages in real-time"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("div",{className:(0,M.cn)("flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-medium text-white",J.color),children:[J.icon,J.label]}),(0,a.jsx)(I.w,{size:"sm",variant:"outline",onClick:()=>K(!1),disabled:V,leftIcon:(0,a.jsx)(h.Z,{className:(0,M.cn)("h-4 w-4",V&&"animate-spin")}),children:es?"Reconnect":"Start Session"}),(0,a.jsx)(I.w,{size:"sm",variant:"ghost",onClick:()=>X(),disabled:V,children:"Reset"})]})]}),(0,a.jsxs)(l.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:"flex flex-1 min-h-0 gap-4 rounded-xl border border-border bg-card/50 backdrop-blur overflow-hidden",children:[(0,a.jsxs)("aside",{className:(0,M.cn)("flex flex-col border-r border-border bg-card/80","list"===t?"flex w-full":"hidden","md:flex md:w-[340px]"),children:[(0,a.jsxs)("div",{className:"border-b border-border p-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsx)("h2",{className:"font-semibold text-foreground",children:"Conversations"}),(0,a.jsx)("span",{className:(0,M.cn)("rounded-full px-2 py-0.5 text-xs font-medium",es?"bg-green-500/10 text-green-500":"bg-muted text-muted-foreground"),children:es?"Live":"Offline"})]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(g.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,a.jsx)("input",{value:d,onChange:e=>u(e.target.value),placeholder:"Search conversations...",className:"w-full rounded-lg border border-border bg-background pl-10 pr-4 py-2 text-sm outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),(0,a.jsx)("div",{className:"flex gap-2 mt-3",children:W.map(e=>(0,a.jsxs)("button",{onClick:()=>G(e.key),className:(0,M.cn)("flex items-center gap-1.5 rounded-full px-3 py-1.5 text-xs font-medium transition-all",T===e.key?"bg-primary text-primary-foreground shadow-sm":"bg-muted text-muted-foreground hover:bg-muted/80"),children:[e.icon,e.label]},e.key))})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===Y.length?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-6 text-center",children:[(0,a.jsx)(o.Z,{className:"h-12 w-12 text-muted-foreground/50 mb-3"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"No conversations found"}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground/70 mt-1",children:es?"Start chatting!":"Connect WhatsApp to see chats"})]}):(0,a.jsx)("div",{className:"p-2 space-y-1",children:Y.map((e,t)=>{var s,r;let n=e.id===P;return(0,a.jsxs)(l.E.button,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.03*t},onClick:()=>$(e.id),className:(0,M.cn)("w-full flex items-center gap-3 rounded-lg p-3 text-left transition-all",n?"bg-primary/10 border border-primary/30":"hover:bg-muted/50"),children:[(0,a.jsx)("div",{className:(0,M.cn)("flex h-12 w-12 items-center justify-center rounded-full text-sm font-semibold",n?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"),children:O(e.name)}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,a.jsx)("p",{className:(0,M.cn)("font-medium truncate",n?"text-primary":"text-foreground"),children:e.name}),(0,a.jsx)("span",{className:"text-[10px] text-muted-foreground shrink-0",children:(null===(s=e.lastMessage)||void 0===s?void 0:s.timestamp)?L(e.lastMessage.timestamp):""})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2 mt-0.5",children:[(0,a.jsx)("p",{className:"text-xs text-muted-foreground truncate",children:(null===(r=e.lastMessage)||void 0===r?void 0:r.text)||"No messages yet"}),e.unreadCount>0&&(0,a.jsx)("span",{className:"flex h-5 min-w-[20px] items-center justify-center rounded-full bg-primary px-1.5 text-[10px] font-bold text-primary-foreground",children:e.unreadCount})]})]})]},e.id)})})})]}),(0,a.jsx)("div",{className:(0,M.cn)("flex flex-1 flex-col","chat"===t?"flex":"hidden","md:flex"),children:et?(0,a.jsx)("div",{className:"flex flex-1 items-center justify-center p-6",children:(0,a.jsxs)(l.E.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center gap-6 max-w-md text-center",children:[(0,a.jsx)("div",{className:"rounded-full bg-primary/10 p-4",children:(0,a.jsx)(x.Z,{className:"h-8 w-8 text-primary"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-foreground mb-2",children:"Scan QR Code"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Open WhatsApp on your phone → Linked devices → Link a device"})]}),(0,a.jsx)("div",{className:"rounded-2xl border border-border bg-white p-4 shadow-lg",children:(0,a.jsx)(r.default,{src:D.qrImage,alt:"WhatsApp QR",width:240,height:240})}),(0,a.jsx)(I.w,{variant:"outline",onClick:()=>K(!0),disabled:V,leftIcon:(0,a.jsx)(h.Z,{className:(0,M.cn)("h-4 w-4",V&&"animate-spin")}),children:"Refresh QR Code"})]})}):(null==D?void 0:D.status)!=="connected"?(0,a.jsx)("div",{className:"flex flex-1 items-center justify-center p-6",children:(0,a.jsxs)(l.E.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center gap-6 max-w-md text-center",children:[(0,a.jsx)("div",{className:"rounded-full bg-primary/10 p-4",children:(0,a.jsx)(o.Z,{className:"h-8 w-8 text-primary"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-foreground mb-2",children:"Start WhatsApp Session"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Connect your WhatsApp to start receiving and sending messages"})]}),(null==D?void 0:D.status)==="error"&&D.lastError&&(0,a.jsxs)("div",{className:"flex items-center gap-2 rounded-lg border border-red-500/30 bg-red-500/10 px-4 py-2 text-sm text-red-400",children:[(0,a.jsx)(f.Z,{className:"h-4 w-4"}),D.lastError]}),(0,a.jsx)(I.w,{onClick:()=>K(!1),disabled:V,leftIcon:(0,a.jsx)(h.Z,{className:(0,M.cn)("h-4 w-4",V&&"animate-spin")}),children:"Start Session"})]})}):F?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("button",{onClick:()=>s("list"),className:"rounded-lg p-2 hover:bg-muted md:hidden",children:(0,a.jsx)(b.Z,{className:"h-5 w-5"})}),(0,a.jsx)("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-primary text-sm font-semibold text-primary-foreground",children:O(F.name)}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-semibold text-foreground",children:F.name}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:es?"Online":"Offline"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)("button",{className:"rounded-lg p-2 text-muted-foreground hover:bg-muted hover:text-foreground",children:(0,a.jsx)(j.Z,{className:"h-5 w-5"})}),(0,a.jsx)("button",{className:"rounded-lg p-2 text-muted-foreground hover:bg-muted hover:text-foreground",children:(0,a.jsx)(v.Z,{className:"h-5 w-5"})}),(0,a.jsx)("button",{className:"rounded-lg p-2 text-muted-foreground hover:bg-muted hover:text-foreground",children:(0,a.jsx)(y.Z,{className:"h-5 w-5"})})]})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[(0,a.jsx)(i.M,{children:z.map((e,t)=>{let s=e.fromMe;return(0,a.jsx)(l.E.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{delay:.02*t},className:(0,M.cn)("flex",s?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:(0,M.cn)("max-w-[75%] rounded-2xl px-4 py-2 shadow-sm",s?"bg-primary text-primary-foreground rounded-br-md":"bg-muted text-foreground rounded-bl-md"),children:[(0,a.jsx)("p",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:e.text}),(0,a.jsxs)("div",{className:(0,M.cn)("flex items-center justify-end gap-1 mt-1",s?"text-primary-foreground/70":"text-muted-foreground"),children:[(0,a.jsx)("span",{className:"text-[10px]",children:L(e.timestamp)}),s&&(0,a.jsx)(N.Z,{className:"h-3.5 w-3.5"})]})]})},e.id)})}),(0,a.jsx)("div",{ref:q})]}),(0,a.jsx)("div",{className:"border-t border-border p-4",children:(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault(),ee()},className:"flex items-end gap-2",children:[(0,a.jsx)("button",{type:"button",className:"rounded-lg p-2.5 text-muted-foreground hover:bg-muted hover:text-foreground",children:(0,a.jsx)(w.Z,{className:"h-5 w-5"})}),(0,a.jsx)("button",{type:"button",className:"rounded-lg p-2.5 text-muted-foreground hover:bg-muted hover:text-foreground",children:(0,a.jsx)(C.Z,{className:"h-5 w-5"})}),(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)("textarea",{value:R,onChange:e=>_(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),ee())},placeholder:"Type a message...",rows:1,className:"w-full resize-none rounded-xl border border-border bg-background px-4 py-2.5 text-sm outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 max-h-32"})}),R.trim()?(0,a.jsx)(I.w,{type:"submit",size:"icon",className:"h-10 w-10 rounded-xl",disabled:H,children:(0,a.jsx)(k.Z,{className:"h-5 w-5"})}):(0,a.jsx)("button",{type:"button",className:"flex h-10 w-10 items-center justify-center rounded-xl bg-primary text-primary-foreground",children:(0,a.jsx)(S.Z,{className:"h-5 w-5"})})]})})]}):(0,a.jsx)("div",{className:"flex flex-1 items-center justify-center p-6",children:(0,a.jsxs)(l.E.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center gap-4 max-w-md text-center",children:[(0,a.jsx)("div",{className:"rounded-full bg-primary/10 p-6",children:(0,a.jsx)(o.Z,{className:"h-12 w-12 text-primary"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-semibold text-foreground mb-2",children:"Select a conversation"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Choose a chat from the list to view messages and start replying"})]}),(0,a.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Logged in as"," ",(0,a.jsx)("span",{className:"font-medium text-foreground",children:null==e?void 0:e.email})]})]})})})]})]})}},45036:function(e,t,s){"use strict";s.d(t,{BX:function(){return l},ML:function(){return n},fk:function(){return i},iL:function(){return o},vh:function(){return c},wi:function(){return r}});var a=s(45118);async function r(e){return(0,a.SC)("/api/whatsapp/session/init",{method:"POST",body:{forceNewSession:e}})}async function n(){return(0,a.SC)("/api/whatsapp/session/status")}async function l(){return(0,a.SC)("/api/whatsapp/session/reset",{method:"POST"})}async function i(){return(0,a.SC)("/api/whatsapp/chats")}async function c(e){return(0,a.SC)("/api/whatsapp/chats/".concat(encodeURIComponent(e),"/messages"))}async function o(e,t){await (0,a.SC)("/api/whatsapp/chats/"+encodeURIComponent(e)+"/messages",{method:"POST",body:{text:t}})}}},function(e){e.O(0,[1294,7787,2386,1316,5611,1293,1528,1744],function(){return e(e.s=40555)}),_N_E=e.O()}]);